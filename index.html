<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Scanner ke Google Sheet (Auto Reset Kasir Mode)</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body style="font-family:sans-serif; text-align:center; padding:20px; background:#f8f9fa;">

  <h2>ðŸ“· QR / Barcode Scanner</h2>
  <div id="reader" style="width:300px; margin:auto;"></div>
  <p style="margin-top:20px; font-size:18px;">Hasil Scan: <span id="result">-</span></p>

  <!-- Suara OK -->
  <audio id="okSound">
    <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" type="audio/ogg">
  </audio>

  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbwPZRWHrCxkoF11VHQMweNM8CXr5bWKN4ezJOMSTN8u9rjtqcWwwdM6VJvCILW8SR7M9A/exec";
    const okSound = document.getElementById("okSound");

    let lastScan = "";
    let lastTime = 0;

    function saveToLocalStorage(code) {
      let data = JSON.parse(localStorage.getItem("scannedData") || "[]");
      data.push({ code: code, time: new Date().toISOString() });
      localStorage.setItem("scannedData", JSON.stringify(data));
    }

    function syncData() {
      let data = JSON.parse(localStorage.getItem("scannedData") || "[]");
      if (data.length === 0) return;

      const item = data[0];
      fetch(SHEET_URL + "?kode=" + encodeURIComponent(item.code))
        .then(res => res.text())
        .then(txt => {
          console.log("Respon server:", txt);
          data.shift();
          localStorage.setItem("scannedData", JSON.stringify(data));
        })
        .catch(err => console.error("Error sync:", err));
    }

    const html5QrCode = new Html5Qrcode("reader");

    function startScanner() {
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          const now = Date.now();
          if (decodedText === lastScan && (now - lastTime) < 1000) {
            return; // abaikan duplikat 1 detik
          }
          lastScan = decodedText;
          lastTime = now;

          document.getElementById("result").textContent = decodedText;
          okSound.play();

          saveToLocalStorage(decodedText);
          syncData();

          // Stop sebentar lalu restart scanner biar siap scan lagi
          html5QrCode.stop().then(() => {
            setTimeout(() => startScanner(), 800); // restart setelah 0.8 detik
          });
        },
        (errorMessage) => {
          // error scanning diabaikan
        }
      );
    }

    startScanner();
    setInterval(syncData, 5000);
  </script>
</body>
</html>
