<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>QR Scanner Poka-Yoke</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; background: #000; color:#fff; }
    #reader { width: 50%; height: 50vh; margin: auto; } /* kamera setengah layar hp */
    #result { font-size: 22px; margin-top: 15px; font-weight: bold; }
    #history { margin-top: 20px; max-height: 200px; overflow-y: auto; background:#111; padding:10px; border-radius:8px; text-align:left; }
    #history h3 { margin:0 0 10px 0; font-size:18px; display:flex; justify-content:space-between; align-items:center; }
    #history ul { list-style:none; padding:0; margin:0; }
    #history li { padding:4px 0; border-bottom:1px solid #333; font-size:16px; }
    button { margin:10px; padding:10px 20px; border:none; border-radius:8px; background:#ff4444; color:#fff; font-size:16px; cursor:pointer; }
  </style>
</head>
<body>
  <h2>QR Scanner dengan Poka-Yoke</h2>
  <div style="margin:10px 0">
    <button onclick="resetPokaYoke()" style="background:#444; color:#fff; border:none; padding:8px 12px; border-radius:6px; cursor:pointer;">Reset Pokaâ€‘Yoke</button>
    <small style="display:block; color:#aaa; margin-top:6px;">Reset ini hanya menghapus daftar kode yang sudah pernah discan di perangkat ini (localStorage). Data di Google Sheet tidak berubah.</small>
  </div>
  <div id="reader"></div>
  <div id="result">Hasil scan akan muncul di sini</div>

  <div id="history">
    <h3>
      Riwayat Scan
    </h3>
    <ul id="scanList"></ul>
  </div>

  <button onclick="resetPokaYoke()">ðŸ”„ Reset Poka-Yoke</button>

  <script>
  const SHEET_URL = "https://script.google.com/macros/s/AKfycbwPZRWHrCxkoF11VHQMweNM8CXr5bWKN4ezJOMSTN8u9rjtqcWwwdM6VJvCILW8SR7M9A/exec";

  let scannedCodes = JSON.parse(localStorage.getItem("scannedCodes") || "[]");
  let isProcessing = false;
  let isSyncing = false;

  // Suara
  const okSound = new Audio("https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg");
  const errorSound = new Audio("https://actions.google.com/sounds/v1/alarms/beep_short.ogg");

  const html5QrCode = new Html5Qrcode("reader");

  function updateHistory(newCode) {
    const scanList = document.getElementById("scanList");
    const li = document.createElement("li");
    li.textContent = `${new Date().toLocaleTimeString()} â†’ ${newCode}`;
    scanList.prepend(li);
  }

  function onScanSuccess(decodedText) {
    if (isProcessing) return;
    isProcessing = true;

    html5QrCode.stop().then(() => {
      // Poka-yoke permanent
      if (scannedCodes.includes(decodedText)) {
        errorSound.play();
        console.log("Kode sudah pernah dipakai:", decodedText);
        isProcessing = false;
        restartScanner();
        return;
      }

      // Simpan ke history poka-yoke
      scannedCodes.push(decodedText);
      localStorage.setItem("scannedCodes", JSON.stringify(scannedCodes));

      document.getElementById("result").textContent = decodedText;
      okSound.play();
      updateHistory(decodedText);

      // Simpan ke buffer sync
      saveToBuffer(decodedText);
      syncData();

      // Reset scanner biar siap lagi
      setTimeout(() => {
        isProcessing = false;
        restartScanner();
      }, 800);
    });
  }

  function restartScanner() {
    html5QrCode.start(
      { facingMode: "environment" },
      { fps: 10 }, // Fullscreen (tanpa qrbox)
      onScanSuccess
    );
  }

  function saveToBuffer(code) {
    let buffer = JSON.parse(localStorage.getItem("scannedData") || "[]");
    buffer.push({ code, time: new Date().toISOString() });
    localStorage.setItem("scannedData", JSON.stringify(buffer));
  }

  function syncData() {
    if (isSyncing) return;
    let buffer = JSON.parse(localStorage.getItem("scannedData") || "[]");
    if (buffer.length === 0) return;

    isSyncing = true;
    let item = buffer[0];

    fetch(SHEET_URL + "?kode=" + encodeURIComponent(item.code))
      .then(res => res.text())
      .then(txt => {
        console.log("Respon server:", txt);
        buffer.shift(); // hapus data yg sudah terkirim
        localStorage.setItem("scannedData", JSON.stringify(buffer));
        isSyncing = false;

        if (buffer.length > 0) syncData(); // lanjutkan sisa buffer
      })
      .catch(err => {
        console.error("Error sync:", err);
        isSyncing = false;
      });
  }

  function resetPokaYoke() {
    localStorage.removeItem("scannedCodes");
    scannedCodes = [];
    alert("âœ… Poka-Yoke telah di-reset. Semua kode bisa discan ulang.");
  }

  setInterval(syncData, 5000);

  // Start scanner saat load
  restartScanner();
  // Reset Poka-Yoke: hapus daftar kode yang pernah discan di perangkat ini
  function resetPokaYoke() {
    localStorage.removeItem('scannedCodes');
    scannedCodes = [];
    console.log('Poka-Yoke direset di perangkat ini');
    alert('Pokaâ€‘Yoke direset. Kode yang pernah discan bisa dipakai lagi di perangkat ini.');
  }
  </script>
</body>
</html>
