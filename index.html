<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Scanner ke Google Sheet (Poka-Yoke Permanent)</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body style="font-family:sans-serif; text-align:center; padding:20px; background:#f8f9fa;">

  <h2>ðŸ“· QR / Barcode Scanner</h2>
  <div id="reader" style="width:100%; margin:auto;"></div>
  <p style="margin-top:20px; font-size:18px;">Hasil Scan: <span id="result">-</span></p>

  <!-- Suara OK -->
  <audio id="okSound">
    <source src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" type="audio/ogg">
  </audio>
  <!-- Suara Error -->
  <audio id="errorSound">
    <source src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" type="audio/ogg">
  </audio>

  <script>
    const SHEET_URL = "https://script.google.com/macros/s/AKfycbwPZRWHrCxkoF11VHQMweNM8CXr5bWKN4ezJOMSTN8u9rjtqcWwwdM6VJvCILW8SR7M9A/exec";
    const okSound = document.getElementById("okSound");
    const errorSound = document.getElementById("errorSound");

    // Simpan semua kode yang sudah pernah discan (poka-yoke)
    let scannedCodes = JSON.parse(localStorage.getItem("scannedCodes") || "[]");

    function saveToLocalStorage(code) {
      let data = JSON.parse(localStorage.getItem("scannedData") || "[]");
      data.push({ code: code, time: new Date().toISOString() });
      localStorage.setItem("scannedData", JSON.stringify(data));
    }

    function syncData() {
      let data = JSON.parse(localStorage.getItem("scannedData") || "[]");
      if (data.length === 0) return;

      const item = data[0];
      fetch(SHEET_URL + "?kode=" + encodeURIComponent(item.code))
        .then(res => res.text())
        .then(txt => {
          console.log("Respon server:", txt);
          data.shift();
          localStorage.setItem("scannedData", JSON.stringify(data));
        })
        .catch(err => console.error("Error sync:", err));
    }

    const html5QrCode = new Html5Qrcode("reader");

    function startScanner() {
      html5QrCode.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
          if (scannedCodes.includes(decodedText)) {
            console.log("Kode sudah pernah discan, abaikan.");
            errorSound.play();
            return; // poka-yoke permanent
          }

          // Simpan kode baru ke daftar poka-yoke
          scannedCodes.push(decodedText);
          localStorage.setItem("scannedCodes", JSON.stringify(scannedCodes));

          document.getElementById("result").textContent = decodedText;
          okSound.play();

          saveToLocalStorage(decodedText);
          syncData();

          // Stop sebentar lalu restart scanner
          html5QrCode.stop().then(() => {
            setTimeout(() => startScanner(), 800);
          });
        },
        (errorMessage) => {
          // abaikan error
        }
      );
    }

    startScanner();
    setInterval(syncData, 5000);
  </script>
</body>
</html>

